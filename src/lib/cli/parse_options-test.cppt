#include "../../../.build_files/src/lib/cli/parse_options.h"

upd::new_cli::options parse(std::vector<const char*> argv) {
  argv.push_back(nullptr);
  return upd::new_cli::parse_options(argv.data());
}

@case "parse_options() parses the command `update`" {
  auto opts = parse({ "upd", "update", nullptr });
  @expect(opts.command == upd::new_cli::command::update);
}

@case "parse_options() parses the command `help`" {
  auto opts = parse({ "upd", "help", nullptr });
  @expect(opts.command == upd::new_cli::command::help);
}

@case "parse_options() throws on invalid command" {
  try {
    auto opts = parse({ "upd", "foo", nullptr });
    @expect(false);
  } catch (upd::new_cli::invalid_command_error error) {}
}

@case "parse_options() has default for --all" {
  auto opts = parse({ "upd", "update", nullptr });
  @expect(!opts.all);
}

@case "parse_options() parses --all" {
  auto opts = parse({ "upd", "update", "--all", nullptr });
  @expect(opts.all);
}

@case "parse_options() throws if --all is used with incorrect command" {
  try {
    auto opts = parse({ "upd", "help", "--all", nullptr });
    @expect(false);
  } catch (upd::new_cli::unavailable_option_for_command_error error) {}
}

@case "parse_options() parses --color-diagnostics" {
  const char* argv[] = { "upd", "update", nullptr };
  auto opts = upd::new_cli::parse_options(argv);
  @expect(opts.color_diagnostics == upd::new_cli::color_diagnostics::auto_);
}

@case "parse_options() parses --color-diagnostics always" {
  const char* argv[] = { "upd", "update", "--color-diagnostics", "always", nullptr };
  auto opts = upd::new_cli::parse_options(argv);
  @expect(opts.color_diagnostics == upd::new_cli::color_diagnostics::always);
}

@case "parse_options() thrown on invalid --color-diagnostics" {
  const char* argv[] = { "upd", "update", "--color-diagnostics", "foobar", nullptr };
  try {
    auto opts = upd::new_cli::parse_options(argv);
    @expect(false);
  } catch (upd::new_cli::invalid_color_diagnostics_error error) {
    @expect(error.value == "foobar");
  }
}

@case "parse_options() parses --concurrency auto" {
  auto opts = parse({ "upd", "update", "--concurrency", "auto" });
  @expect(opts.concurrency == 0);
}

@case "parse_options() parses --concurrency <number>" {
  auto opts = parse({ "upd", "update", "--concurrency", "42" });
  @expect(opts.concurrency == 42);
}
